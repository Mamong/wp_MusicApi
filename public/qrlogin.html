<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>二维码登录</title>
</head>

<body>
  <img id="qrImg" />
  <div id="info" class="info"></div>
  <script src="https://cdn.jsdelivr.net/npm/axios@0.26.1/dist/axios.min.js
    "></script>
  <script>
    //获取data.qrcode
    //https://login-user.kugou.com/v1/qrcode?appid=1014&clientver=8131&clienttime=1678877922&uuid=cfa34291f215cebc7d5f3e211c92537b&mid=cfa34291f215cebc7d5f3e211c92537b&type=1&signature=db8ddfb444665764e3a973bdd096a795
    //二维码地址：https://h5.kugou.com/apps/loginQRCode/html/index.html?qrcode=xxx&appid=1014
    //status:0失效 1有效
    //https://login-user.kugou.com/v1/get_userinfo_qrcode?appid=1014&clientver=8131&clienttime=1678877923&uuid=cfa34291f215cebc7d5f3e211c92537b&qrcode=376c11a0ce8af58231c34c7f4670c6921014&dfid=1bnVWb3ltxuE4e4dUN4MoW6E&mid=cfa34291f215cebc7d5f3e211c92537b&plat=4&signature=09a915f0447b94814a4a7531f3125064
    async function checkStatus(key) {
      const res = await axios({
        url: `/login/qr/check?key=${key}&timestamp=${Date.now()}`,
      })
      return res.data
    }
    async function getLoginStatus(cookie = '') {
      const res = await axios({
        url: `/login/status?timestamp=${Date.now()}`,
        method: 'post',
        data: {
          cookie,
        },
      })
      document.querySelector('#info').innerText = JSON.stringify(res.data, null, 2)
    }
    async function login() {
      let timer
      let timestamp = Date.now()
      const cookie = localStorage.getItem('cookie')
      this.getLoginStatus(cookie)
      const res = await axios({
        url: `/login/qr/key?timestamp=${Date.now()}`,
      })
      const key = res.data.data.unikey
      const res2 = await axios({
        url: `/login/qr/create?key=${key}&qrimg=true&timestamp=${Date.now()}`,
      })
      document.querySelector('#qrImg').src = res2.data.data.qrimg

      timer = setInterval(async () => {
        const statusRes = await this.checkStatus(key)
        if (statusRes.code === 800) {
          alert('二维码已过期,请重新获取')
          clearInterval(timer)
        }
        if (statusRes.code === 803) {
          // 这一步会返回cookie
          clearInterval(timer)
          alert('授权登录成功')
          await this.getLoginStatus(statusRes.cookie)
          localStorage.setItem('cookie', statusRes.cookie)
        }
      }, 3000)
    }
    login()
  </script>
  <style>
    .info {
      white-space: pre;
    }
  </style>
</body>

</html>